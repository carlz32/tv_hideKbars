# 会话高亮 + 计数 + EMA 指标（TradingView / Pine v6）

本仓库包含一个 Pine Script v6 指标 `SessionFilter & Bar Counter & EMA`，用于在 TradingView 图表中：
- 高亮指定交易会话并着色背景
- 在会话内每隔 X 根 K 线标注计数标签
- 绘制两条 EMA（当前周期与 1 小时），可选择“仅会话内递推并跨会话延续”的模式
- 在每个会话结束时，基于本次会话的收盘/最高/最低绘制向右水平射线，并在右侧添加标签

## 快速开始
- 打开 TradingView → Pine Editor，将 `main.pine` 内容复制粘贴到编辑器
- 保存并将脚本添加到图表
- 在指标的输入面板中根据需要调整参数

## 主要功能
- 会话高亮：基于 `sess`（会话时段）与 `sessTz`（时区）判断是否在会话内，并在会话内为背景着色
- 会话计数：会话内从第一根 K 开始计数；每隔 `c_contador` 根在当前 K 下方绘制计数标签
- EMA（当前周期/1 小时）：
  - 开启“仅会话EMA”时，在会话外保持前值不更新（水平延续），在新会话从该值继续递推
  - 关闭时使用标准连续 `ta.ema`
- 会话结束水平射线与标签：在会话结束时绘制本次会话的收盘/最高/最低三条水平射线，并将“收盘/最高/最低”标签固定在图表右侧，无背景、更显眼

## 参数说明（输入分组）
- 会话
  - `会话时段`：默认 `0930-1615`
  - `会话时区(空=图表时区)`：默认 `UTC+8`
  - `会话背景着色`、`会话背景颜色`
- 计数
  - `标签尺寸`：`Auto/Large/Medium/Small/Tiny`
  - `文字颜色`
  - `每隔X根显示一次`
- EMA
  - `EMA长度`（默认 20）
  - `仅会话EMA`（开：会话感知并延续；关：常规连续）
- 水平射线
  - `绘制会话水平射线`
  - `收盘射线颜色`、`最高射线颜色`、`最低射线颜色`
  - `射线宽度`
  - `标签右侧偏移(根数)`：标签相对最新 K 的水平偏移，固定在右侧
  - `标签尺寸`：`Large/Normal/Small`

## 逻辑要点（代码参考）
- 会话检测与背景着色：`main.pine:21-28`
- 会话内计数与标签：`main.pine:31-51`
- 会话极值维护（最高/最低/收盘）：`main.pine:53-64`
- 会话结束判定与射线、标签绘制：`main.pine:65-91`
- 当前周期 EMA 绘制：`main.pine:92-113`
- 1 小时 EMA 绘制：`main.pine:114-129`

## 常见问题
- `plot` 的 `title` 必须是常量字符串：代码已改为常量标题，避免运行时条件导致的类型错误
- 对象配额：已在指标声明中设置 `max_labels_count=500`、`max_lines_count=500`，若遇到限制可适当调大或减少绘制频率
- 会话时区：将 `会话时区` 设为空字符串可使用图表/交易所时区；默认 `UTC-4`

## 建议用法
- 日内交易场景：保持会话为开盘-收盘时段，开启“仅会话EMA”以避免隔夜数据影响均线
- 射线与标签：通过颜色与尺寸区分收盘/最高/最低，并使用偏移将标签固定在图表右侧，减少遮挡